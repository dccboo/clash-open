name: sub-convert-to-gist

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: read

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare workspace
        run: |
          mkdir -p out

      - name: Pull subconverter image
        run: |
          docker pull tindy2013/subconverter:latest

      - name: Start subconverter
        run: |
          docker rm -f subconverter >/dev/null 2>&1 || true
          docker run -d --name subconverter -p 25500:25500 tindy2013/subconverter:latest

          for i in $(seq 1 30); do
            if curl -fsS "http://127.0.0.1:25500/version" >/dev/null 2>&1; then
              echo "subconverter is up"
              exit 0
            fi
            sleep 1
          done

          echo "subconverter failed to start"
          docker logs subconverter || true
          exit 1

      - name: Convert subscription to Clash
        env:
          SUB_URL: ${{ secrets.SUB_URL }}
        run: |
          curl -fsS -G "http://127.0.0.1:25500/sub" \
            --data-urlencode "target=clash" \
            --data-urlencode "list=true" \
            --data-urlencode "url=${SUB_URL}" \
            -o out/clash.yaml

          test -s out/clash.yaml
          grep -q "proxies:" out/clash.yaml || grep -q "proxy-providers:" out/clash.yaml

      - name: Update secret gist file
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          python3 - <<'PY'
          import json, os, pathlib, sys, urllib.request

          p = pathlib.Path("out/clash.yaml")
          data = p.read_text(encoding="utf-8", errors="ignore")

          payload = {
              "files": {
                  "clash.yaml": {
                      "content": data
                  }
              }
          }

          req = urllib.request.Request(
              f"https://api.github.com/gists/{os.environ['GIST_ID']}",
              data=json.dumps(payload).encode("utf-8"),
              method="PATCH",
              headers={
                  "Authorization": f"token {os.environ['GIST_TOKEN']}",
                  "Accept": "application/vnd.github+json",
                  "User-Agent": "sub-convert-workflow"
              },
          )

          try:
              with urllib.request.urlopen(req) as resp:
                  if resp.status not in (200, 201):
                      print("Unexpected status:", resp.status)
                      sys.exit(1)
          except Exception as e:
              print("Failed to update gist:", e)
              sys.exit(1)

          print("Gist updated successfully.")
          PY

      - name: Cleanup
        if: always()
        run: |
          docker rm -f subconverter >/dev/null 2>&1 || true
