
name: sub-convert-to-gist

on:
  workflow_dispatch:
  schedule:
    - cron: "45 * * * *"

permissions:
  contents: read

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare workspace
        run: |
          mkdir -p out
          test -f profiles/AOFlast.ini

      - name: Pull subconverter image
        run: |
          docker pull tindy2013/subconverter:latest

      - name: Start subconverter (with profiles mounted)
        run: |
          docker rm -f subconverter >/dev/null 2>&1 || true
          docker run -d --name subconverter \
            -p 25500:25500 \
            -v "${{ github.workspace }}/profiles:/base/profiles" \
            tindy2013/subconverter:latest

          # Wait for service to be ready (do NOT use -f; / may return 404)
          for i in $(seq 1 30); do
            if curl -sS "http://127.0.0.1:25500/" >/dev/null 2>&1; then
              echo "subconverter is up"
              exit 0
            fi
            sleep 1
          done

          echo "subconverter failed to start"
          docker logs subconverter || true
          exit 1

      - name: Convert subscription using AOFlast.ini (full config)
        env:
          SUB_URL: ${{ secrets.SUB_URL }}
        run: |
      - name: Convert subscription using AOFlast.ini (debug 400)
        env:
          SUB_URL: ${{ secrets.SUB_URL }}
        run: |
          set -e

          curl -sS -G "http://127.0.0.1:25500/sub" \
            -H "User-Agent: Clash Verge" \
            --http1.1 \
            --data-urlencode "target=clash" \
            --data-urlencode "url=${SUB_URL}" \
            --data-urlencode "config=profiles/AOFlast.ini" \
            -o out/clash.yaml \
            -w "\nHTTP=%{http_code}\n"

          echo "==== response head (may be error message) ===="
          head -n 160 out/clash.yaml

          echo "==== subconverter logs tail ===="
          docker logs subconverter | tail -n 200 || true

          # 如果不是正常配置，直接失败退出（避免继续写入 Gist）
          grep -q "proxy-groups:" out/clash.yaml
          grep -q "^rules:" out/clash.yaml || grep -q "\nrules:" out/clash.yaml

          # Sanity checks: must be non-empty and look like a full Clash config
          test -s out/clash.yaml
          grep -q "proxy-groups:" out/clash.yaml
          grep -q "^rules:" out/clash.yaml || grep -q "\nrules:" out/clash.yaml

      - name: Install PyYAML
        run: |
          python3 -m pip install --disable-pip-version-check -q pyyaml

      - name: Inject group icons
        run: |
          python3 - <<'PY'
          import yaml
          from pathlib import Path

          ICONS = {
              "香港节点": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/hk.svg",
              "日本节点": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/jp.svg",
              "台湾节点": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/tw.svg",
              "新加坡节点": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/sg.svg",
              "美国节点": "https://fastly.jsdelivr.net/gh/clash-verge-rev/clash-verge-rev.github.io@main/docs/assets/icons/flags/us.svg",
          }

          for fn in ["out/clash.yaml"]:
              p = Path(fn)
              if not p.exists():
                  continue

              data = yaml.safe_load(p.read_text(encoding="utf-8", errors="ignore"))
              groups = data.get("proxy-groups", [])

              for g in groups:
                  if g.get("name") in ICONS:
                      g["icon"] = ICONS[g["name"]]

              p.write_text(
                  yaml.safe_dump(data, allow_unicode=True, sort_keys=False),
                  encoding="utf-8"
              )

              print(f"Injected icons into {fn}")
          PY

      - name: Update secret gist file (clash.yaml)
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          python3 - <<'PY'
          import json, os, pathlib, sys, urllib.request

          p = pathlib.Path("out/clash.yaml")
          data = p.read_text(encoding="utf-8", errors="ignore")

          payload = {
              "files": {
                  "clash.yaml": {
                      "content": data
                  }
              }
          }

          req = urllib.request.Request(
              f"https://api.github.com/gists/{os.environ['GIST_ID']}",
              data=json.dumps(payload).encode("utf-8"),
              method="PATCH",
              headers={
                  "Authorization": f"token {os.environ['GIST_TOKEN']}",
                  "Accept": "application/vnd.github+json",
                  "User-Agent": "sub-convert-workflow"
              },
          )

          try:
              with urllib.request.urlopen(req) as resp:
                  if resp.status not in (200, 201):
                      print("Unexpected status:", resp.status)
                      sys.exit(1)
          except Exception as e:
              print("Failed to update gist:", e)
              sys.exit(1)

          print("Gist updated successfully.")
          PY

      - name: Cleanup
        if: always()
        run: |
          docker rm -f subconverter >/dev/null 2>&1 || true
